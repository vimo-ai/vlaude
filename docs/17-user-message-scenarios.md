# User æ¶ˆæ¯ 17 ç§åœºæ™¯å®Œæ•´æ¸…å•

> åŸºäºå¯¹ **50,147 æ¡** user æ¶ˆæ¯çš„åˆ†æ
> æ•°æ®æ¥æºï¼š`/scripts/user-message-scenarios.json`
> åˆ†æè„šæœ¬ï¼š`/scripts/analyze-user-message-types.js`

---

## ğŸ“Š å æ¯”æ±‡æ€»

| ç±»åˆ« | åœºæ™¯æ•° | æ¶ˆæ¯æ•° | å æ¯” |
|------|--------|--------|------|
| **åº”è¯¥æ˜¾ç¤º** | 9 ç§ | 8,912 | 17.77% |
| **ä¸åº”è¯¥æ˜¾ç¤º** | 8 ç§ | 41,235 | 82.23% |
| **æ€»è®¡** | 17 ç§ | 50,147 | 100% |

---

## âœ… åº”è¯¥æ˜¾ç¤ºçš„åœºæ™¯ï¼ˆ17.77%ï¼‰

### 1. ç”¨æˆ·æ¶ˆæ¯+æ€è€ƒå…ƒæ•°æ® - 13.29% (6,669 æ¡)

**ç‰¹å¾ç»„åˆ**: `thinkingMetadata + content:string`

**çœŸå®ç¤ºä¾‹**:
```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": "çœ‹ä¸‹å½“å‰é¡¹ç›®ï¼Œé‡ç‚¹æ˜¯/rpc-viewå’Œfrida-server..."
  },
  "thinkingMetadata": {
    "thinkingBudget": 10000,
    "thinkingEnabled": true
  }
}
```

**å¤„ç†æ–¹æ¡ˆ**:
- âœ… æ­£å¸¸æ˜¾ç¤ºä¸ºç”¨æˆ·æ¶ˆæ¯
- å¯é€‰å±•ç¤ºæ€è€ƒå›¾æ ‡ï¼ˆğŸ’­ï¼‰
- Swift: `DisplayMessage.thinkingMetadata` å­—æ®µ

---

### 2. ç”¨æˆ·ä¸­æ–­è¯·æ±‚ - 2.41% (1,208 æ¡)

**ç‰¹å¾ç»„åˆ**: `content:array[text]`

**çœŸå®ç¤ºä¾‹**:
```json
{
  "message": {
    "content": [{
      "type": "text",
      "text": "[Request interrupted by user for tool use]"
    }]
  }
}
```

**å¤„ç†æ–¹æ¡ˆ**:
- âœ… æ˜¾ç¤ºä¸ºç³»ç»Ÿæç¤ºï¼š"â¸ï¸ ç”¨æˆ·ä¸­æ–­äº†è¯·æ±‚"
- Swift: `DisplayMessage.isInterrupted = true`
- UI: ç‰¹æ®Šæ ·å¼ï¼ˆç°è‰²ã€æ–œä½“ç­‰ï¼‰

---

### 3. æ™®é€šæ–‡æœ¬æ¶ˆæ¯ - 1.15% (578 æ¡)

**ç‰¹å¾ç»„åˆ**: `content:string`

**çœŸå®ç¤ºä¾‹**:
```json
{
  "message": {
    "content": "ä½ å¥½"
  }
}
```

**å¤„ç†æ–¹æ¡ˆ**:
- âœ… æ ‡å‡†çš„ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤º
- æ— ç‰¹æ®Šæ ‡è¯†

---

### 4. ç”¨æˆ·æ¶ˆæ¯+æ€è€ƒ+æ–‡æœ¬æ•°ç»„ - 0.72% (362 æ¡)

**ç‰¹å¾ç»„åˆ**: `thinkingMetadata + content:array[text]`

**å¤„ç†æ–¹æ¡ˆ**:
- âœ… åŒåœºæ™¯ 1ï¼Œä½†éœ€è¦è§£ææ•°ç»„ä¸­çš„æ–‡æœ¬

---

### 5. ç”¨æˆ·æ¶ˆæ¯+æ€è€ƒ+å›¾ç‰‡ - 0.14% (71 æ¡)

**ç‰¹å¾ç»„åˆ**: `thinkingMetadata + content:array[image, text]`

**çœŸå®ç¤ºä¾‹**:
```json
{
  "message": {
    "content": [
      {
        "type": "image",
        "source": {
          "type": "base64",
          "media_type": "image/png",
          "data": "iVBORw0KGgo..."
        }
      },
      {
        "type": "text",
        "text": "è¿™æ˜¯ä»€ä¹ˆé”™è¯¯ï¼Ÿ"
      }
    ]
  },
  "thinkingMetadata": {...}
}
```

**å¤„ç†æ–¹æ¡ˆ**:
- âœ… æ˜¾ç¤ºå›¾ç‰‡ + æ–‡æœ¬
- Swift: `DisplayMessage.images: [ImageData]`

---

### 6. çº¯å›¾ç‰‡æ¶ˆæ¯ - 0.04% (21 æ¡)

**ç‰¹å¾ç»„åˆ**: `content:array[image]`

**å¤„ç†æ–¹æ¡ˆ**:
- âœ… åªæ˜¾ç¤ºå›¾ç‰‡ï¼Œæ— æ–‡æœ¬

---

### 7-9. å¤šå›¾ç‰‡æ¶ˆæ¯ - 0.01% (3 æ¡)

**ç‰¹å¾ç»„åˆ**:
- `thinkingMetadata + content:array[image, image, text]`
- `thinkingMetadata + content:array[image, image, image, text]`
- `thinkingMetadata + content:array[image, image, image, image, image, text]`

**å¤„ç†æ–¹æ¡ˆ**:
- âœ… æ˜¾ç¤ºå¤šå¼ å›¾ç‰‡ + æ–‡æœ¬

---

## âŒ ä¸åº”è¯¥æ˜¾ç¤ºçš„åœºæ™¯ï¼ˆ82.23%ï¼‰

### 1. å·¥å…·æ‰§è¡Œç»“æœ - 80.96% (40,602 æ¡) â­ **æœ€é‡è¦**

**ç‰¹å¾ç»„åˆ**: `toolUseResult + hasToolResult + content:array[tool_result]`

**çœŸå®ç¤ºä¾‹**:
```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": [{
      "type": "tool_result",
      "content": "æ–‡ä»¶å†…å®¹...",
      "is_error": false,
      "tool_use_id": "toolu_01Bgx7Ph539BpQoGUxEfveut"
    }]
  },
  "toolUseResult": {
    "toolName": "Read",
    "result": "...",
    "isError": false
  }
}
```

**å¤„ç†æ–¹æ¡ˆ**:
- âŒ **ä¸ä½œä¸ºç‹¬ç«‹ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤º**
- âœ… **åˆå¹¶åˆ° Assistant æ¶ˆæ¯çš„å·¥å…·è°ƒç”¨ä¸­**
- Swift: `MessageTransformer` è‡ªåŠ¨åˆå¹¶
- UI: æ˜¾ç¤ºåœ¨ Assistant æ¶ˆæ¯å†…éƒ¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– Assistant                        â”‚
â”‚ è®©æˆ‘è¯»å–è¿™ä¸ªæ–‡ä»¶                      â”‚
â”‚                                     â”‚
â”‚ ğŸ”§ è°ƒç”¨å·¥å…·: Read                    â”‚
â”‚   ğŸ“„ file_path: /path/to/file       â”‚
â”‚   âœ… æ‰§è¡ŒæˆåŠŸ                         â”‚
â”‚   â””â”€ æ–‡ä»¶å†…å®¹...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. å‹ç¼©æ‘˜è¦ - 0.80% (400 æ¡)

**ç‰¹å¾ç»„åˆ**: `visibleInTranscriptOnly + compactSummary + content:string`

**çœŸå®ç¤ºä¾‹**:
```json
{
  "message": {
    "content": "This session is being continued from a previous conversation..."
  },
  "isVisibleInTranscriptOnly": true,
  "isCompactSummary": true
}
```

**å¤„ç†æ–¹æ¡ˆ**:
- âŒ å®Œå…¨ä¸æ˜¾ç¤º
- åŸå› ï¼šä¼šè¯å‹ç¼©çš„å†…éƒ¨æœºåˆ¶ï¼Œç”¨æˆ·ä¸éœ€è¦çœ‹åˆ°

---

### 3. å…ƒæ•°æ®æ¶ˆæ¯ï¼ˆå­—ç¬¦ä¸²ï¼‰ - 0.32% (162 æ¡)

**ç‰¹å¾ç»„åˆ**: `isMeta + content:string`

**å¤„ç†æ–¹æ¡ˆ**:
- âŒ ä¸æ˜¾ç¤º
- åŸå› ï¼šç³»ç»Ÿå†…éƒ¨å…ƒæ•°æ®

---

### 4. å…ƒæ•°æ®æ¶ˆæ¯ï¼ˆæ•°ç»„ï¼‰ - 0.09% (45 æ¡)

**ç‰¹å¾ç»„åˆ**: `isMeta + content:array[text]`

**çœŸå®ç¤ºä¾‹**:
```json
{
  "message": {
    "content": [{
      "type": "text",
      "text": "Caveat: The messages below were generated by the user while running local commands..."
    }]
  },
  "isMeta": true
}
```

**å¤„ç†æ–¹æ¡ˆ**:
- âŒ ä¸æ˜¾ç¤º
- åŸå› ï¼šSlash command æ‰©å±•å†…å®¹ã€Caveat æç¤ºç­‰

---

### 5. å‹ç¼©æ‘˜è¦ï¼ˆæ•°ç»„ï¼‰ - 0.04% (21 æ¡)

**ç‰¹å¾ç»„åˆ**: `visibleInTranscriptOnly + compactSummary + content:array[text]`

**å¤„ç†æ–¹æ¡ˆ**:
- âŒ ä¸æ˜¾ç¤º

---

### 6. ä»… Transcript å¯è§ - 0.01% (4 æ¡)

**ç‰¹å¾ç»„åˆ**: `visibleInTranscriptOnly + content:array[text]`

**å¤„ç†æ–¹æ¡ˆ**:
- âŒ ä¸æ˜¾ç¤º
- åŸå› ï¼šä»…è°ƒè¯•å¯è§

---

### 7. å·¥å…·ç»“æœï¼ˆæ—  toolUseResultï¼‰ - 0.01% (1 æ¡)

**ç‰¹å¾ç»„åˆ**: `hasToolResult + content:array[tool_result]`

**å¤„ç†æ–¹æ¡ˆ**:
- âŒ ä¸æ˜¾ç¤º
- âœ… åˆå¹¶åˆ° Assistant æ¶ˆæ¯

---

### 8. å…ƒæ•°æ®+æ–‡æ¡£ - 0.00% (0 æ¡)

**ç‰¹å¾ç»„åˆ**: `isMeta + content:array[document]`

**å¤„ç†æ–¹æ¡ˆ**:
- âŒ ä¸æ˜¾ç¤º

---

## ğŸ” è¿‡æ»¤è§„åˆ™æ€»ç»“

### Swift ç«¯è¿‡æ»¤é€»è¾‘

```swift
func shouldDisplayUserMessage(_ msg: Message) -> Bool {
    // 1. å·¥å…·æ‰§è¡Œç»“æœ - ä¸æ˜¾ç¤º
    if msg.toolUseResult != nil { return false }
    if hasToolResultInContent(msg) { return false }

    // 2. ä»… Transcript å¯è§ - ä¸æ˜¾ç¤º
    if msg.isVisibleInTranscriptOnly == true { return false }

    // 3. å‹ç¼©æ‘˜è¦ - ä¸æ˜¾ç¤º
    if msg.isCompactSummary == true { return false }

    // 4. å…ƒæ•°æ®æ¶ˆæ¯ - ä¸æ˜¾ç¤º
    if msg.isMeta == true { return false }

    return true  // å…¶ä»–æƒ…å†µæ˜¾ç¤º
}
```

---

## ğŸ“ æ•°æ®æ–‡ä»¶ä½ç½®

- **JSON æŠ¥å‘Š**: `/scripts/user-message-scenarios.json` (7.8MBï¼ŒåŒ…å«æ‰€æœ‰æ ·æœ¬æ•°æ®)
- **åˆ†æè„šæœ¬**: `/scripts/analyze-user-message-types.js`
- **å®ç°æ–‡ä»¶**: `/packages/Vlaude/Vlaude/Services/MessageTransformer.swift`

---

## âœ… å®ç°çŠ¶æ€

| åœºæ™¯ | MessageTransformer æ”¯æŒ | UI å®ç° |
|------|------------------------|---------|
| 1. æ€è€ƒå…ƒæ•°æ® | âœ… | â¬œ |
| 2. ä¸­æ–­æ¶ˆæ¯ | âœ… | â¬œ |
| 3. æ™®é€šæ–‡æœ¬ | âœ… | â¬œ |
| 4. æ–‡æœ¬æ•°ç»„ | âœ… | â¬œ |
| 5. å›¾ç‰‡æ¶ˆæ¯ | âœ… | â¬œ |
| å·¥å…·ç»“æœåˆå¹¶ | âœ… | â¬œ |
| å‹ç¼©æ‘˜è¦è¿‡æ»¤ | âœ… | - |
| å…ƒæ•°æ®è¿‡æ»¤ | âœ… | - |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. â¬œ å®ç° UI ç»„ä»¶æ˜¾ç¤ºä¸åŒç±»å‹çš„æ¶ˆæ¯
2. â¬œ æµ‹è¯• MessageTransformer çš„å¢é‡æ›´æ–°
3. â¬œ å®ç°å·¥å…·æ‰§è¡Œçš„ UI å±•ç¤ºï¼ˆæŠ˜å /å±•å¼€ï¼‰
4. â¬œ å®ç°å›¾ç‰‡æ¶ˆæ¯çš„æ˜¾ç¤º
5. â¬œ å®ç°ä¸­æ–­æ¶ˆæ¯çš„ç‰¹æ®Šæ ·å¼

---

**æœ€åæ›´æ–°**: 2025-11-17
